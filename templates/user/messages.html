<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - House-Forge</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--cream:#FAF8F5;--warm-white:#FFFFFF;--sand:#F0EBE3;--stone:#E2D9CE;--accent:#B5804F;--accent-dark:#8C5E35;--accent-light:#F7EDE2;--text-primary:#1C1917;--text-secondary:#6B5E52;--text-muted:#9C8E84;--shadow-sm:0 1px 3px rgba(28,25,23,0.06);--shadow-md:0 4px 16px rgba(28,25,23,0.08);}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'DM Sans',sans-serif;background:var(--cream);min-height:100vh;color:var(--text-primary);}
        .navbar{background:var(--warm-white);border-bottom:1px solid var(--stone);padding:0 40px;height:68px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-sm);}
        .navbar-brand{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:10px;text-decoration:none;}
        .navbar-menu{display:flex;align-items:center;gap:4px;}
        .navbar-menu a{color:var(--text-secondary);text-decoration:none;padding:8px 14px;border-radius:8px;font-size:14px;font-weight:500;transition:all 0.2s;}
        .navbar-menu a:hover,.navbar-menu a.active{color:var(--accent);background:var(--accent-light);}
        .profile-pic{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--stone);}
        .profile-placeholder{width:36px;height:36px;border-radius:50%;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;border:2px solid var(--stone);}

        /* LAYOUT */
        .chat-layout{display:flex;height:calc(100vh - 68px);}

        /* LEFT PANEL */
        .convos-panel{width:360px;background:var(--warm-white);border-right:1px solid var(--stone);display:flex;flex-direction:column;flex-shrink:0;}
        .convos-header{padding:20px 20px 0;border-bottom:1px solid var(--sand);}
        .convos-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:14px;}
        .search-wrap{position:relative;margin-bottom:14px;}
        .search-wrap input{width:100%;padding:10px 14px 10px 38px;border:1.5px solid var(--stone);border-radius:20px;font-size:13px;font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text-primary);transition:all 0.2s;}
        .search-wrap input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(181,128,79,0.12);}
        .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:14px;}
        .filter-tabs{display:flex;gap:6px;padding:10px 20px;background:var(--sand);border-bottom:1px solid var(--stone);}
        .filter-tab{padding:6px 14px;background:var(--warm-white);border:1.5px solid var(--stone);border-radius:16px;font-size:12px;font-weight:600;cursor:pointer;color:var(--text-secondary);transition:all 0.2s;font-family:'DM Sans',sans-serif;}
        .filter-tab:hover{border-color:var(--accent);color:var(--accent);}
        .filter-tab.active{background:var(--accent);color:white;border-color:var(--accent);}
        .convos-list{flex:1;overflow-y:auto;}
        .convo-item{padding:14px 20px;border-bottom:1px solid var(--sand);cursor:pointer;display:flex;gap:12px;align-items:flex-start;transition:all 0.2s;}
        .convo-item:hover{background:var(--sand);}
        .convo-item.active{background:var(--accent-light);border-left:3px solid var(--accent);}
        .convo-item.unread{background:#FEF9F0;}
        .convo-avatar{width:44px;height:44px;border-radius:50%;background:var(--accent-light);border:2px solid var(--stone);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
        .convo-content{flex:1;min-width:0;}
        .convo-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:3px;}
        .convo-name{font-weight:600;font-size:14px;color:var(--text-primary);}
        .convo-time{font-size:11px;color:var(--text-muted);white-space:nowrap;}
        .convo-preview{font-size:13px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .convo-item.unread .convo-preview{font-weight:600;color:var(--text-secondary);}
        .unread-badge{display:inline-block;background:var(--accent);color:white;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;margin-top:4px;}

        /* CHAT PANEL */
        .chat-panel{flex:1;display:flex;flex-direction:column;background:var(--cream);}
        .chat-header{padding:18px 28px;border-bottom:1px solid var(--stone);display:flex;align-items:center;gap:14px;background:var(--warm-white);box-shadow:var(--shadow-sm);}
        .chat-avatar{width:42px;height:42px;border-radius:50%;background:var(--accent-light);border:2px solid var(--stone);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
        .chat-name{font-family:'Playfair Display',serif;font-size:16px;font-weight:600;color:var(--text-primary);}
        .chat-sub{font-size:12px;color:var(--text-muted);}
        .chat-actions-right{margin-left:auto;}
        .btn-sm{padding:7px 14px;background:var(--sand);border:1px solid var(--stone);border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;color:var(--text-secondary);transition:all 0.2s;font-family:'DM Sans',sans-serif;}
        .btn-sm:hover{background:var(--stone);}
        .messages-area{flex:1;overflow-y:auto;padding:24px 28px;display:flex;flex-direction:column;gap:6px;}
        .date-divider{text-align:center;position:relative;margin:16px 0;}
        .date-divider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--stone);}
        .date-divider span{background:var(--cream);padding:4px 14px;border-radius:12px;font-size:11px;color:var(--text-muted);font-weight:600;position:relative;z-index:1;}
        .message{display:flex;gap:8px;align-items:flex-end;}
        .message.sent{flex-direction:row-reverse;}
        .msg-avatar{width:30px;height:30px;border-radius:50%;background:var(--accent-light);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
        .message.sent .msg-avatar{background:#D1FAE5;}
        .msg-content{max-width:58%;}
        .msg-bubble{padding:11px 15px;border-radius:16px;background:var(--warm-white);font-size:13px;line-height:1.5;color:var(--text-primary);box-shadow:var(--shadow-sm);word-wrap:break-word;}
        .message.sent .msg-bubble{background:var(--accent);color:white;}
        .msg-time{font-size:10px;color:var(--text-muted);margin-top:4px;padding:0 4px;}
        .message.sent .msg-time{text-align:right;}
        .input-area{padding:16px 28px;border-top:1px solid var(--stone);background:var(--warm-white);}
        .input-row{display:flex;gap:12px;align-items:flex-end;}
        .input-wrap{flex:1;}
        .input-wrap textarea{width:100%;padding:11px 16px;border:1.5px solid var(--stone);border-radius:20px;font-size:14px;font-family:'DM Sans',sans-serif;resize:none;max-height:100px;transition:all 0.2s;color:var(--text-primary);background:var(--cream);}
        .input-wrap textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(181,128,79,0.12);}
        .send-btn{width:42px;height:42px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0;}
        .send-btn:hover{background:var(--accent-dark);transform:scale(1.05);}
        .send-btn:disabled{background:var(--stone);cursor:not-allowed;transform:none;}
        .empty-chat{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-muted);text-align:center;padding:40px;}
        .empty-chat-icon{font-size:64px;margin-bottom:16px;opacity:0.5;}
        .empty-chat h2{font-family:'Playfair Display',serif;color:var(--text-secondary);margin-bottom:8px;font-size:22px;}
        .typing-dot{width:7px;height:7px;border-radius:50%;background:var(--text-muted);animation:typing 1.4s infinite;display:inline-block;margin:0 2px;}
        .typing-dot:nth-child(2){animation-delay:0.2s;}
        .typing-dot:nth-child(3){animation-delay:0.4s;}
        @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
        .convos-list::-webkit-scrollbar,.messages-area::-webkit-scrollbar{width:5px;}
        .convos-list::-webkit-scrollbar-thumb,.messages-area::-webkit-scrollbar-thumb{background:var(--stone);border-radius:3px;}
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('user.dashboard') }}" class="navbar-brand">üèóÔ∏è House-Forge</a>
        <div class="navbar-menu">
            <a href="{{ url_for('user.dashboard') }}">Dashboard</a>
            <a href="{{ url_for('user.projects') }}">My Projects</a>
            <a href="{{ url_for('user.my_orders') }}">My Orders</a>
            <a href="{{ url_for('user.messages') }}" class="active">Messages</a>
            <a href="{{ url_for('user.profile') }}" style="padding:8px 10px;">
                {% if user_profile_picture %}
                    <img src="/static/uploads/profiles/{{ user_profile_picture }}" alt="Profile" class="profile-pic">
                {% else %}
                    <div class="profile-placeholder">{{ current_user.name[0].upper() if current_user.name else 'U' }}</div>
                {% endif %}
            </a>
            <a href="{{ url_for('auth.logout') }}" style="color:var(--text-muted);font-size:13px;">Logout</a>
        </div>
    </nav>

    <div class="chat-layout">
        <!-- Conversations panel -->
        <div class="convos-panel">
            <div class="convos-header">
                <div class="convos-title">Messages</div>
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Search conversations‚Ä¶">
                </div>
            </div>
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All</button>
                <button class="filter-tab" data-filter="contractor">Contractors</button>
                <button class="filter-tab" data-filter="supplier">Suppliers</button>
                <button class="filter-tab" data-filter="unread">Unread</button>
            </div>
            <div class="convos-list" id="convosList"></div>
        </div>

        <!-- Chat panel -->
        <div class="chat-panel" id="chatPanel">
            <div class="empty-chat">
                <div class="empty-chat-icon">üí¨</div>
                <h2>Select a conversation</h2>
                <p>Choose a contractor or supplier to start messaging</p>
            </div>
        </div>
    </div>

    <script>
        let conversations=[], currentConvo=null, messages={};
        function getParam(n){return new URLSearchParams(window.location.search).get(n);}
        document.addEventListener('DOMContentLoaded',()=>{ loadConvos(); setupListeners(); });
        function setupListeners(){
            document.querySelectorAll('.filter-tab').forEach(t=>t.addEventListener('click',function(){
                document.querySelectorAll('.filter-tab').forEach(x=>x.classList.remove('active'));
                this.classList.add('active'); filterConvos(this.dataset.filter);
            }));
            document.getElementById('searchInput').addEventListener('input',e=>searchConvos(e.target.value));
        }
        function loadConvos(){
            fetch('/user/messages/conversations').then(r=>r.json()).then(d=>{
                conversations=d.conversations||[]; renderConvos(conversations);
                const id=getParam('open'), type=getParam('type');
                if(id&&type) setTimeout(()=>openConvo(id,type),500);
            }).catch(()=>emptyConvos());
        }
        function renderConvos(cvs){
            const el=document.getElementById('convosList');
            if(!cvs.length){emptyConvos();return;}
            el.innerHTML=cvs.map(c=>`
                <div class="convo-item ${c.unread_count>0?'unread':''}" data-id="${c.id}" data-type="${c.sender_type}" onclick="openConvo('${c.id}','${c.sender_type}')">
                    <div class="convo-avatar">${c.sender_type==='contractor'?'üî®':'üì¶'}</div>
                    <div class="convo-content">
                        <div class="convo-top"><span class="convo-name">${c.sender_name}</span><span class="convo-time">${fmtTime(c.last_message_time)}</span></div>
                        <div class="convo-preview">${c.last_message||''}</div>
                        ${c.unread_count>0?`<span class="unread-badge">${c.unread_count}</span>`:''}
                    </div>
                </div>`).join('');
        }
        function emptyConvos(){document.getElementById('convosList').innerHTML=`<div style="text-align:center;padding:48px 20px;color:var(--text-muted)"><div style="font-size:48px;margin-bottom:12px">üì≠</div><p>No messages yet</p></div>`;}
        function openConvo(id,type){
            currentConvo=id;
            document.querySelectorAll('.convo-item').forEach(i=>{i.classList.remove('active');if(i.dataset.id===id&&i.dataset.type===type)i.classList.add('active');});
            fetch(`/user/messages/conversation/${id}?type=${type}`).then(r=>r.json()).then(d=>{
                messages[id]=d.messages||[]; renderChat(id,d.contact_info,type);
            });
        }
        function renderChat(id,info,type){
            const panel=document.getElementById('chatPanel');
            panel.innerHTML=`
                <div class="chat-header">
                    <div class="chat-avatar">${type==='contractor'?'üî®':'üì¶'}</div>
                    <div><div class="chat-name">${info.name}</div><div class="chat-sub">${type.charAt(0).toUpperCase()+type.slice(1)}</div></div>
                    <div class="chat-actions-right"><button class="btn-sm" onclick="window.location='/user/${type}/${id}'">üë§ View Profile</button></div>
                </div>
                <div class="messages-area" id="msgsArea">${renderMsgs(id,type)}</div>
                <div class="input-area">
                    <form id="msgForm" onsubmit="sendMsg(event,'${id}','${type}')">
                        <div class="input-row">
                            <div class="input-wrap"><textarea id="msgInput" placeholder="Type a message‚Ä¶" rows="1" onkeypress="handleKey(event)"></textarea></div>
                            <button type="submit" class="send-btn" id="sendBtn">‚û§</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('msgInput').addEventListener('input',()=>{
                const t=document.getElementById('msgInput');t.style.height='auto';t.style.height=Math.min(t.scrollHeight,100)+'px';
            });
            scrollBottom();
        }
        function renderMsgs(id,type){
            const msgs=messages[id]||[];
            if(!msgs.length)return`<div style="text-align:center;color:var(--text-muted);margin-top:48px">Start the conversation!</div>`;
            let html='',lastDate=null;
            msgs.forEach(m=>{
                const d=new Date(m.created_at).toDateString();
                if(d!==lastDate){html+=`<div class="date-divider"><span>${fmtDate(m.created_at)}</span></div>`;lastDate=d;}
                const sent=m.direction==='outgoing';
                html+=`<div class="message ${sent?'sent':''}">
                    <div class="msg-avatar">${sent?'üë§':(type==='contractor'?'üî®':'üì¶')}</div>
                    <div class="msg-content">
                        <div class="msg-bubble">${escHtml(m.message)}</div>
                        <div class="msg-time">${fmtMsgTime(m.created_at)}${sent&&m.read?' ¬∑ Read':''}</div>
                    </div></div>`;
            });
            return html;
        }
        function sendMsg(e,id,type){
            e.preventDefault();
            const input=document.getElementById('msgInput'), msg=input.value.trim();
            if(!msg)return;
            const btn=document.getElementById('sendBtn');btn.disabled=true;
            const fd=new FormData();fd.append('message',msg);fd.append('recipient_type',type);
            fetch(`/user/messages/send/${id}`,{method:'POST',body:fd}).then(r=>r.json()).then(d=>{
                if(d.success){
                    if(!messages[id])messages[id]=[];
                    messages[id].push({message:msg,direction:'outgoing',created_at:new Date().toISOString(),read:false});
                    renderChat(id,{name:conversations.find(c=>c.id===id)?.sender_name||'Contact'},type);
                    input.value='';input.style.height='auto';loadConvos();
                }
            }).finally(()=>btn.disabled=false);
        }
        function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('msgForm').dispatchEvent(new Event('submit'));}}
        function scrollBottom(){const a=document.getElementById('msgsArea');if(a)setTimeout(()=>a.scrollTop=a.scrollHeight,80);}
        function filterConvos(f){
            let c=conversations;
            if(f==='contractor')c=c.filter(x=>x.sender_type==='contractor');
            else if(f==='supplier')c=c.filter(x=>x.sender_type==='supplier');
            else if(f==='unread')c=c.filter(x=>x.unread_count>0);
            renderConvos(c);
        }
        function searchConvos(q){renderConvos(conversations.filter(c=>c.sender_name.toLowerCase().includes(q.toLowerCase())||c.last_message?.toLowerCase().includes(q.toLowerCase())));}
        function fmtTime(ts){if(!ts)return'';const d=new Date(ts),now=new Date(),diff=now-d,min=Math.floor(diff/60000);if(min<1)return'Now';if(min<60)return min+'m';if(diff<86400000)return Math.floor(diff/3600000)+'h';return d.toLocaleDateString();}
        function fmtDate(ts){const d=new Date(ts),today=new Date(),yest=new Date(today);yest.setDate(yest.getDate()-1);if(d.toDateString()===today.toDateString())return'Today';if(d.toDateString()===yest.toDateString())return'Yesterday';return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
        function fmtMsgTime(ts){return new Date(ts).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});}
        function escHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
        setInterval(()=>{if(currentConvo){const t=conversations.find(c=>c.id===currentConvo)?.sender_type;if(t)openConvo(currentConvo,t);}loadConvos();},30000);
    </script>
</body>
</html>